<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Werkpakket Scanner</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
  <style>
    :root {
      --bg: #0a0e14; --bg2: #111720; --bg3: #1a2233;
      --accent: #f5a623; --green: #2dff8a; --red: #ff3d5a;
      --text: #c8d6e8; --text-dim: #5a7a9a; --border: #1e3050;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: 'Barlow Condensed', sans-serif; min-height: 100vh; }

    .header { background: var(--bg2); border-bottom: 2px solid var(--accent); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
    .header-logo { font-size: 22px; font-weight: 700; color: var(--accent); text-transform: uppercase; }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--text-dim); }
    .status-dot.ready { background: var(--green); box-shadow: 0 0 8px var(--green); }
    .status-dot.scanning { background: var(--accent); box-shadow: 0 0 8px var(--accent); }

    .tabs { display: flex; background: var(--bg2); border-bottom: 1px solid var(--border); }
    .tab { flex: 1; padding: 15px; text-align: center; font-size: 15px; font-weight: 600; text-transform: uppercase; color: var(--text-dim); cursor: pointer; }
    .tab.active { color: var(--accent); border-bottom: 3px solid var(--accent); }

    .page { display: none; padding: 20px; }
    .page.active { display: block; }

    .scanner-wrap { position: relative; background: #000; border: 2px solid var(--border); border-radius: 4px; overflow: hidden; aspect-ratio: 1; max-width: 460px; margin: 0 auto; }
    #scanner-video { width: 100%; height: 100%; object-fit: cover; }
    #canvas-hidden { display: none; }
    
    .btn { display: flex; justify-content: center; width: 100%; padding: 16px; border: none; border-radius: 4px; font-family: 'Barlow Condensed', sans-serif; font-size: 18px; font-weight: 700; text-transform: uppercase; cursor: pointer; margin-top: 15px; }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-danger { background: transparent; color: var(--red); border: 1px solid var(--red); }

    .result-card { display: none; margin-top: 20px; background: var(--bg2); border: 1px solid var(--border); padding: 15px; border-radius: 4px; }
    .result-card.visible { display: block; }
    .result-card.success { border-color: var(--green); }
    .result-card.error { border-color: var(--red); }
    .result-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
    .result-value { font-family: 'Share Tech Mono', monospace; font-size: 18px; margin-bottom: 10px; }
    .btn-open { display: block; width: 100%; text-align: center; padding: 15px; background: var(--green); color: #000; text-decoration: none; font-size: 18px; font-weight: 700; text-transform: uppercase; border-radius: 4px; margin-top: 10px; }

    .drop-zone { border: 2px dashed var(--border); border-radius: 4px; padding: 40px 20px; text-align: center; cursor: pointer; background: var(--bg2); }
    .drop-zone input { position: absolute; opacity: 0; width: 10px; }
    .drop-zone.loaded { border-color: var(--green); }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--bg3); border: 1px solid var(--green); padding: 12px 20px; border-radius: 4px; display: none; color: var(--green); z-index: 1000; }
    
    /* Manual input style */
    .manual-input-wrap { display: flex; gap: 10px; margin-top: 16px; }
    .manual-input { flex: 1; background: var(--bg2); border: 1px solid var(--border); border-radius: 3px; padding: 12px; color: var(--text); font-family: 'Share Tech Mono', monospace; font-size: 14px; outline: none; }
    .btn-search { background: var(--bg3); border: 1px solid var(--border); border-radius: 3px; padding: 12px 18px; color: var(--accent); font-size: 20px; cursor: pointer; }
  </style>
</head>
<body>

<div class="header">
  <div class="header-logo">WP Scanner</div>
  <div class="status-dot" id="statusDot"></div>
</div>

<div class="tabs">
  <div class="tab active" id="tab-scan" onclick="switchTab('scan')">Scanner</div>
  <div class="tab" id="tab-setup" onclick="switchTab('setup')">Instellen</div>
</div>

<div class="page active" id="page-scan">
  <div class="scanner-wrap">
    <video id="scanner-video" playsinline autoplay muted></video>
    <canvas id="canvas-hidden"></canvas>
  </div>
  
  <button class="btn btn-primary" id="btnScan" onclick="startScanner()">Start Scanner</button>
  <button class="btn btn-danger" id="btnStop" onclick="stopScanner()" style="display:none">Stop Scanner</button>

  <div class="manual-input-wrap">
    <input class="manual-input" id="manualInput" type="text" placeholder="Handmatig invoeren..." onkeydown="if(event.key==='Enter') searchManual()">
    <button class="btn-search" onclick="searchManual()">&#8981;</button>
  </div>

  <div class="result-card" id="resultCard">
    <div id="resultBody"></div>
  </div>
</div>

<div class="page" id="page-setup">
  <div class="drop-zone" id="dropZone" onclick="document.getElementById('csvInput').click()">
    <input type="file" id="csvInput" onchange="loadCSV(this.files[0])">
    <h3 id="dzText" style="color:var(--text); margin-bottom:10px;">Klik hier om CSV te laden</h3>
    <p style="color:var(--text-dim); font-size:14px;">Laad werkpakket_mapping.csv</p>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  let mapping = {};
  let scanning = false;
  let videoStream = null;
  let animFrame = null;
  let lastResult = null;
  let isDetecting = false;
  
  // MAGIC TRICK: Activeer de in-browser hardware scanner van Android
  let nativeScanner = null;
  if ('BarcodeDetector' in window) {
    try { nativeScanner = new BarcodeDetector({ formats: ['qr_code', 'data_matrix'] }); } 
    catch(e) { console.log('Native scanner init failed'); }
  }

  window.onload = function() {
    try {
      const saved = localStorage.getItem('wp_mapping');
      if (saved) {
        mapping = JSON.parse(saved);
        if (Object.keys(mapping).length > 0) {
          document.getElementById('statusDot').className = 'status-dot ready';
          document.getElementById('dzText').textContent = Object.keys(mapping).length + ' items geladen';
          document.getElementById('dropZone').classList.add('loaded');
          return; // blijf op scan tab
        }
      }
    } catch(e) {}
    switchTab('setup');
  };

  function switchTab(tab) {
    document.getElementById('page-scan').style.display = (tab === 'scan') ? 'block' : 'none';
    document.getElementById('page-setup').style.display = (tab === 'setup') ? 'block' : 'none';
    document.getElementById('tab-scan').className = (tab === 'scan') ? 'tab active' : 'tab';
    document.getElementById('tab-setup').className = (tab === 'setup') ? 'tab active' : 'tab';
  }

  async function startScanner() {
    if (Object.keys(mapping).length === 0) {
      showToast('Laad eerst een CSV!');
      switchTab('setup');
      return;
    }
    
    try {
      videoStream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' } 
      });
    } catch(e1) {
      try { videoStream = await navigator.mediaDevices.getUserMedia({ video: true }); } 
      catch(e2) { alert('Camera geblokkeerd!'); return; }
    }

    const video = document.getElementById('scanner-video');
    video.srcObject = videoStream;
    await video.play();
    scanning = true;
    lastResult = null;
    document.getElementById('btnScan').style.display = 'none';
    document.getElementById('btnStop').style.display = 'block';
    document.getElementById('statusDot').className = 'status-dot scanning';
    document.getElementById('resultCard').classList.remove('visible');
    
    scanLoop();
  }

  function stopScanner() {
    scanning = false;
    if (animFrame) cancelAnimationFrame(animFrame);
    if (videoStream) videoStream.getTracks().forEach(t => t.stop());
    document.getElementById('btnScan').style.display = 'block';
    document.getElementById('btnStop').style.display = 'none';
    document.getElementById('statusDot').className = 'status-dot ready';
  }

  function scanLoop() {
    if (!scanning) return;
    const video = document.getElementById('scanner-video');
    
    if (video.readyState === video.HAVE_ENOUGH_DATA && !isDetecting) {
      isDetecting = true; // Voorkomt dat de app zichzelf ophangt

      // OPTIE 1: Gebruik de hardware scanner van Android (Supersnel & kan 4K aan)
      if (nativeScanner) {
        nativeScanner.detect(video).then(barcodes => {
          if (barcodes.length > 0 && barcodes[0].rawValue !== lastResult) {
            lastResult = barcodes[0].rawValue;
            handleQR(lastResult);
          }
          isDetecting = false;
          if (scanning) animFrame = requestAnimationFrame(scanLoop);
        }).catch(err => {
          // Als het hardwarematig t√≥ch faalt, val terug op jsQR
          fallbackJsQR(video);
        });
      } else {
        // OPTIE 2: Fallback voor oudere apparaten
        fallbackJsQR(video);
      }
    } else if (!isDetecting) {
      animFrame = requestAnimationFrame(scanLoop);
    }
  }

  function fallbackJsQR(video) {
    const canvas = document.getElementById('canvas-hidden');
    // Verklein het beeld aanzienlijk zodat jsQR niet crasht
    const targetWidth = 600;
    const scale = targetWidth / video.videoWidth;
    canvas.width = targetWidth;
    canvas.height = video.videoHeight * scale;
    
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    
    const code = jsQR(imgData.data, imgData.width, imgData.height, { inversionAttempts: 'attemptBoth' });
    if (code && code.data !== lastResult) {
      lastResult = code.data;
      handleQR(code.data);
    }
    
    isDetecting = false;
    if (scanning) animFrame = requestAnimationFrame(scanLoop);
  }

  function handleQR(value) {
    stopScanner();
    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
    
    const val = value.trim().toUpperCase();
    const entry = mapping[val];
    showResultBox(val, entry);
    
    // Automatisch PDF openen bij gevonden werkpakket
    if (entry) window.open(entry.link, '_blank');
  }
  
  function searchManual() {
    const val = document.getElementById('manualInput').value.trim().toUpperCase();
    if (!val) return;
    showResultBox(val, mapping[val]);
  }

  function showResultBox(val, entry) {
    const card = document.getElementById('resultCard');
    const body = document.getElementById('resultBody');
    if (entry) {
      card.className = 'result-card visible success';
      body.innerHTML = `
        <div class="result-label">Gevonden Scope Item</div>
        <div class="result-value">${entry.scope}</div>
        <a class="btn-open" href="${entry.link}" target="_blank">Open PDF</a>
      `;
    } else {
      card.className = 'result-card visible error';
      body.innerHTML = `
        <div class="result-label">Niet gevonden in CSV</div>
        <div class="result-value" style="color:var(--red);">${val}</div>
      `;
    }
  }

  function loadCSV(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const lines = e.target.result.split(/\r?\n/).filter(l => l.trim());
      mapping = {};
      
      for(let i = 0; i < lines.length; i++) {
        const parts = lines[i].split(/[,;|\t]/).map(p => p.replace(/^"|"$/g, '').trim());
        if (parts.length >= 3 && parts[0] && i > 0) { 
          let link = parts[2];
          const match = link.match(/\/d\/([a-zA-Z0-9_-]+)/);
          if(match) link = 'https://drive.google.com/file/d/' + match[1] + '/view';
          mapping[parts[0].toUpperCase()] = { scope: parts[1], link: link };
        }
      }
      localStorage.setItem('wp_mapping', JSON.stringify(mapping));
      document.getElementById('statusDot').className = 'status-dot ready';
      document.getElementById('dzText').textContent = Object.keys(mapping).length + ' items geladen';
      document.getElementById('dropZone').classList.add('loaded');
      showToast('Geladen!');
      setTimeout(() => switchTab('scan'), 1000);
    };
    reader.readAsText(file, 'UTF-8');
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 2000);
  }
</script>
</body>
</html>
